//
//  UIControllerImageAssets.m
//  ChinaBrowser
//
//  Created by HHY on 14/12/6.
//  Copyright (c) 2014年 KOTO Inc. All rights reserved.
//

#import "UIControllerImageAssets.h"

#define kBtnWH 70
#define kspacing 8

@interface UIControllerImageAssets ()
{
    NSInteger _count;
    NSMutableArray *_arrAssets;
    ALAssetsLibrary *_assetsLibrary;
}
@end

@implementation UIControllerImageAssets

- (void)viewDidLoad {
    [super viewDidLoad];
    
    _viewNav = [UIViewNav viewNav];
    [self.view addSubview:_viewNav];
    //导航栏设置
    UIButton *btnBack =[UIButton buttonWithType:UIButtonTypeCustom];
    [btnBack setImage:[UIImage imageWithBundleFile:@"iPhone/back_0.png"] forState:UIControlStateNormal];
    [btnBack setImage:[UIImage imageWithBundleFile:@"iPhone/back_1.png"] forState:UIControlStateHighlighted];
    [btnBack addTarget:self action:@selector(onTouchBtnback) forControlEvents:UIControlEventTouchUpInside];
    [btnBack sizeToFit];
    _viewNav.leftBarButtonItem = [[UIBarButtonItem alloc]initWithCustomView:btnBack];
    
    [self setupAssets];
}

/**
 *  屏幕旋转
 *
 *  @param toInterfaceOrientation
 *  @param duration
 */
-(void)layoutSubViewsWithInterfaceOrientation:(UIInterfaceOrientation)orientation
{
    if (UIUserInterfaceIdiomPad==UI_USER_INTERFACE_IDIOM()) return;
    
    [_viewNav resizeWithOrientation:orientation];
    
    CGRect rc = _scrollView.frame;
    rc.origin.y = _viewNav.bottom;
    rc.size.height = self.view.height-rc.origin.y;
    _scrollView.frame = rc;
}

/**
 *  返回按钮
 */
- (void)onTouchBtnback
{
    [self.navigationController popViewControllerAnimated:YES];
    
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/**
 *  获得相册里的相片资源
 */
- (void)setupAssets
{
    self.title = [self.assetsGroup valueForProperty:ALAssetsGroupPropertyName];
    _viewNav.title = self.title;
    
    if (!_arrAssets)
        _arrAssets = [[NSMutableArray alloc] init];
    else
        [_arrAssets removeAllObjects];
    
    ALAssetsGroupEnumerationResultsBlock resultsBlock = ^(ALAsset *asset, NSUInteger index, BOOL *stop) {
        
        if (asset)
        {
            [_arrAssets addObject:asset];
            
//            NSString *type = [asset valueForProperty:ALAssetPropertyType];
            
//            if ([type isEqual:ALAssetTypePhoto])
//                self.numberOfPhotos ++;
//            if ([type isEqual:ALAssetTypeVideo])
//                self.numberOfVideos ++;
        }
        
        else if (_arrAssets.count > 0)
        {
            for (int i=0; i<_arrAssets.count; i++) {
                ALAsset *result = _arrAssets[i];
                
                UIButton * btn = [UIButton buttonWithType:UIButtonTypeCustom];
                btn.tag = i;
                
                btn.frame = CGRectMake((i%4+1)*kspacing+i%4*kBtnWH, (i/4+1)*kspacing+i/4*kBtnWH, kBtnWH, kBtnWH);
                btn.backgroundColor = [UIColor orangeColor];
                [btn setImage:[UIImage imageWithCGImage:result.thumbnail] forState:UIControlStateNormal];
                [btn addTarget:self action:@selector(onTouchAssetsImage:) forControlEvents:UIControlEventTouchUpInside];
                
                [_scrollView addSubview:btn];
                _scrollView.contentSize = CGSizeMake(self.view.width, btn.bottom+20);
            }
        }
    };
    
    [self.assetsGroup enumerateAssetsUsingBlock:resultsBlock];
}

-(void)onTouchAssetsImage:(UIButton *)sender
{
    ALAsset *asset = _arrAssets[sender.tag];
    if ([self.delegate respondsToSelector:@selector(controller:didFinishPickingAssets:)])
    [self.delegate controller:self didFinishPickingAssets:asset];
}


@end
